<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quét QR & Barcode</title>
  <script type="module">
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.1/+esm';

    const codeReader = new BrowserMultiFormatReader();
    const videoElement = document.getElementById('video');
    const resultEl = document.getElementById('result');

    let selectedDeviceId;

    // Lấy camera và khởi động
    codeReader.listVideoInputDevices().then(videoInputDevices => {
      if (videoInputDevices.length > 0) {
        selectedDeviceId = videoInputDevices[0].deviceId;

        codeReader.decodeFromVideoDevice(selectedDeviceId, videoElement, (result, err, controls) => {
          if (result) {
            resultEl.innerText = `✅ Đã quét: ${result.getText()}`;
            sendToTelegram(result.getText());
            controls.stop(); // Dừng sau lần quét đầu tiên
          }
        });
      }
    }).catch(err => {
      console.error(err);
    });

    // Gửi Telegram
    function sendToTelegram(message) {
      const telegramToken = '7699635447:AAFnydZdwfRKWRTS1l-VHQtl2dDnAfngLRE';
      const chatId = '5736517117';
      const url = `https://api.telegram.org/bot${telegramToken}/sendMessage`;
      const payload = {
        chat_id: chatId,
        text: `/sp_${message}`
      };
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(res => {
        if (res.ok) console.log("Đã gửi Telegram");
      });
    }

    // Copy
    window.copyResult = () => {
      navigator.clipboard.writeText(resultEl.innerText).then(() => {
        alert("📋 Đã sao chép!");
      });
    };

    // Quét lại
    window.rescan = () => {
      resultEl.innerText = "";
      codeReader.reset();
      codeReader.decodeFromVideoDevice(selectedDeviceId, videoElement, (result, err, controls) => {
        if (result) {
          resultEl.innerText = `✅ Đã quét: ${result.getText()}`;
          sendToTelegram(result.getText());
          controls.stop();
        }
      });
    };
  </script>
</head>
<body>
  <h1>📷 Quét mã QR & Barcode</h1>
  <video id="video" width="300" height="200" style="border:1px solid #ccc;"></video>
  <p id="result"></p>
  <button onclick="rescan()">🔄 Quét lại</button>
  <button onclick="copyResult()">📋 Copy</button>
</body>
</html>
