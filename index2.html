<script>
  const telegramToken = '7699635447:AAFnydZdwfRKWRTS1l-VHQtl2dDnAfngLRE';
  const chatId = '5736517117';

  const html5QrCode = new Html5Qrcode("reader");
  let isScanning = false;
  let currentMode = 'qr'; // default

  function sendToTelegram(message) {
    const url = `https://api.telegram.org/bot${telegramToken}/sendMessage`;
    const payload = {
      chat_id: chatId,
      text: `/sp_${message}`
    };
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).then(res => {
      if (res.ok) console.log("ƒê√£ g·ª≠i ƒë·∫øn Telegram.");
    }).catch(err => console.error("L·ªói khi g·ª≠i:", err));
  }

  function setMode(mode) {
    currentMode = mode;
    startScanner();
  }

  function startScanner() {
    if (isScanning) return;
    isScanning = true;

    let formats;
    let qrbox;

    if (currentMode === 'qr') {
      formats = [Html5QrcodeSupportedFormats.QR_CODE];
      qrbox = 300;
    } else if (currentMode === 'barcode') {
      formats = [Html5QrcodeSupportedFormats.CODE_128];
      qrbox = { width: 400, height: 150 }; // m·ªü r·ªông cho barcode
    }

    html5QrCode.start(
      { facingMode: "environment", width: 1280, height: 720 },
      {
        fps: 5,
        qrbox: qrbox,
        formatsToSupport: formats
      },
      qrMessage => {
        document.getElementById("result").innerText = `‚úÖ ƒê√£ qu√©t (${currentMode.toUpperCase()}): ${qrMessage}`;
        sendToTelegram(qrMessage);
        stopScanner();
      },
      errorMessage => {
        // c√≥ th·ªÉ log n·∫øu c·∫ßn debug
      }
    ).catch(err => {
      console.error("Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông camera:", err);
      isScanning = false;
    });
  }

  function stopScanner() {
    if (!isScanning) return;
    html5QrCode.stop().then(() => {
      isScanning = false;
      document.getElementById("result").innerText += "\n‚èπ ƒê√£ d·ª´ng qu√©t.";
    }).catch(err => {
      console.error("L·ªói khi d·ª´ng camera:", err);
    });
  }

  function copyText() {
    const text = document.getElementById("result").innerText;
    if (text) {
      navigator.clipboard.writeText(text)
        .then(() => alert("üìã ƒê√£ sao ch√©p n·ªôi dung!"))
        .catch(err => alert("‚ùå L·ªói khi sao ch√©p!"));
    }
  }
</script>
