<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuÃ©t Barcode & Gá»­i Telegram</title>
  <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      background: #f7f7f7;
    }
    #scanner {
      width: 100%;
      max-width: 400px;
      height: 300px;
      margin: 20px auto;
      position: relative;
      border: 2px solid #ccc;
      border-radius: 10px;
      background: #000;
    }
    #result {
      font-size: 1.2rem;
      margin-top: 20px;
      color: green;
      white-space: pre-line;
    }
    button {
      padding: 10px 20px;
      font-size: 1rem;
      margin: 10px 5px 0;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h1>ğŸ“¦ QuÃ©t Barcode & Gá»­i Telegram</h1>
  <p>HÆ°á»›ng camera vÃ o mÃ£ váº¡ch in trÃªn thiáº¿t bá»‹ 2</p>

  <div id="scanner"></div>
  <p id="result"></p>

  <button onclick="startBarcodeScanner()">ğŸ” Báº¯t Ä‘áº§u quÃ©t Barcode</button>
  <button onclick="stopScanner()">â›” Dá»«ng quÃ©t</button>
  <button onclick="copyText()">ğŸ“‹ Copy</button>

  <script>
    const telegramToken = '7699635447:AAFnydZdwfRKWRTS1l-VHQtl2dDnAfngLRE';
    const chatId = '5736517117';
    let isScanning = false;

    // XÃ¡c nháº­n láº·p
    let lastCode = '';
    let repeatCount = 0;

    function sendToTelegram(message) {
      const url = `https://api.telegram.org/bot${telegramToken}/sendMessage`;
      const payload = {
        chat_id: chatId,
        text: `/sp_${message}`
      };
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(res => {
        if (res.ok) console.log("âœ… Gá»­i Telegram:", message);
      }).catch(err => console.error("âŒ Lá»—i gá»­i:", err));
    }

    function startBarcodeScanner() {
      if (isScanning) return;
      isScanning = true;
      lastCode = '';
      repeatCount = 0;

      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#scanner'),
          constraints: {
            facingMode: "environment"
          }
        },
        decoder: {
          readers: ["code_128_reader"]
        },
        locate: true,
        locator: {
          patchSize: "x-large",
          halfSample: false
        },
        numOfWorkers: 0,
        frequency: 10,
        debug: {
          drawBoundingBox: true,
          showFrequency: true,
          drawScanline: true,
          showPattern: true
        }
      }, function (err) {
        if (err) {
          console.error("âŒ Lá»—i khá»Ÿi Ä‘á»™ng:", err);
          isScanning = false;
          return;
        }
        Quagga.start();
      });

      Quagga.onDetected(async function (data) {
        const rawCode = data.codeResult.code || '';
        const format = data.codeResult.format || 'unknown';

        // Lá»c chá»‰ nháº­n kÃ½ tá»± Aâ€“Z, 0â€“9 (viáº¿t hoa)
        const code = rawCode.trim().toUpperCase();
        const isValid = /^[A-Z0-9]+$/.test(code);

        console.log("ğŸ“¥ ÄÃ£ quÃ©t:", code, "| Há»£p lá»‡:", isValid, "| Äá»‹nh dáº¡ng:", format);

        if (!isValid) {
          console.warn("â›” MÃ£ khÃ´ng há»£p lá»‡:", code);
          return;
        }

        // XÃ¡c nháº­n trÃ¹ng 2 láº§n
        if (code === lastCode) {
          repeatCount++;
          if (repeatCount >= 2) {
            document.getElementById("result").innerText = `âœ… ÄÃ£ quÃ©t: ${code}\nğŸ“˜ Äá»‹nh dáº¡ng: ${format}`;
            sendToTelegram(code);
            stopScanner();
          }
        } else {
          lastCode = code;
          repeatCount = 1;
        }
      });
    }

    function stopScanner() {
      if (!isScanning) return;
      Quagga.stop();
      Quagga.offDetected();
      isScanning = false;
      document.getElementById("result").innerText += "\nâ›” ÄÃ£ dá»«ng quÃ©t.";
    }

    function copyText() {
      const text = document.getElementById("result").innerText;
      if (text) {
        navigator.clipboard.writeText(text)
          .then(() => alert("ğŸ“‹ ÄÃ£ sao chÃ©p!"))
          .catch(() => alert("âŒ Lá»—i khi sao chÃ©p!"));
      }
    }
  </script>

</body>
</html>
